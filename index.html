<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>JH Â· Erinnerungen</title>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ”’ FIX #7 â€” Content Security Policy
  Erlaubt nur exakt die benÃ¶tigten Quellen.
  'unsafe-inline' bei style/script ist fÃ¼r Firebase ESM nÃ¶tig.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'none';
  script-src 'self' https://www.gstatic.com 'unsafe-inline';
  connect-src https://*.googleapis.com https://*.firebaseio.com https://firestore.googleapis.com https://api.cloudinary.com;
  img-src 'self' https://res.cloudinary.com blob: data:;
  style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
  font-src https://fonts.gstatic.com;
">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --card-size: 200px;
  --bg:        #faf6f0;
  --bg2:       #f3ede4;
  --bg3:       #ede5d8;
  --surface:   #ffffff;
  --accent:    #b07d55;
  --accent2:   #d4a574;
  --accent3:   #e8cba8;
  --text:      #2c1f14;
  --text2:     #6b5040;
  --text3:     #a08070;
  --line:      #d8c8b5;
  --line2:     #c4b09a;
  --gold:      #9a6f3f;
  --red:       #c0503a;
  --green:     #4a8a5a;
  --s1: 0 2px 8px rgba(100,60,20,.10);
  --s2: 0 6px 24px rgba(100,60,20,.14);
  --s3: 0 16px 56px rgba(100,60,20,.18);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;overflow:hidden;overscroll-behavior:none;}

/* â”€â”€â”€ PIN SCREEN â”€â”€â”€ */
#pin-screen{
  position:fixed;inset:0;z-index:1000;
  background:linear-gradient(155deg,#fdf9f3 0%,#ede0cc 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;
}
.pin-logo{font-family:'Cormorant Garamond',serif;font-size:3.4rem;font-weight:600;color:var(--gold);letter-spacing:.12em;text-align:center;animation:logoIn .8s cubic-bezier(.22,1,.36,1) both;}
.pin-logo small{display:block;font-size:.65rem;font-family:'Outfit',sans-serif;font-weight:400;color:var(--text3);letter-spacing:.24em;text-transform:uppercase;margin-top:6px;}
@keyframes logoIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.pin-dots{display:flex;gap:14px;animation:fadeIn .5s .3s both;}
.pin-dot{width:13px;height:13px;border-radius:50%;border:2px solid var(--line2);background:transparent;transition:background .18s,transform .15s,border-color .18s;}
.pin-dot.filled{background:var(--accent);border-color:var(--accent);transform:scale(1.3);}
.pin-grid{display:grid;grid-template-columns:repeat(3,70px);gap:10px;animation:fadeIn .5s .4s both;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.pin-btn{height:70px;border-radius:50%;border:1.5px solid var(--line);background:var(--surface);color:var(--text);font-family:'Outfit',sans-serif;font-size:1.4rem;font-weight:300;cursor:pointer;box-shadow:var(--s1);transition:background .12s,transform .1s;display:flex;align-items:center;justify-content:center;}
.pin-btn:active{background:var(--accent);color:#fff;transform:scale(.88);border-color:var(--accent);}
.pin-btn.del{font-size:1rem;color:var(--text3);}
.pin-error{color:var(--red);font-size:.82rem;opacity:0;transition:opacity .3s;height:18px;text-align:center;animation:fadeIn .5s .5s both;}
.pin-error.show{opacity:1;}
.pin-shake{animation:shake .35s ease both !important;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

/* â”€â”€â”€ LOCKOUT SCREEN (over PIN screen) â”€â”€â”€ */
#lockout-banner{
  position:absolute;bottom:40px;left:0;right:0;text-align:center;
  font-size:.8rem;color:var(--red);font-weight:500;
  opacity:0;transition:opacity .3s;pointer-events:none;
}
#lockout-banner.show{opacity:1;}
#lockout-countdown{font-variant-numeric:tabular-nums;font-size:1.1em;font-weight:600;}

/* â”€â”€â”€ APP â”€â”€â”€ */
#app{height:100%;display:flex;flex-direction:column;opacity:0;transition:opacity .4s;}
#app.ready{opacity:1;}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 10px;background:var(--surface);border-bottom:1px solid var(--line);flex-shrink:0;z-index:10;box-shadow:0 1px 14px rgba(100,60,20,.07);}
.app-title{font-family:'Cormorant Garamond',serif;font-size:1.65rem;font-weight:600;color:var(--gold);letter-spacing:.1em;line-height:1;}
.app-title small{display:block;font-size:.58rem;font-family:'Outfit',sans-serif;font-weight:400;color:var(--text3);letter-spacing:.2em;text-transform:uppercase;margin-top:3px;}
.hdr-r{display:flex;align-items:center;gap:7px;}
#photo-count{font-size:.68rem;color:var(--text3);letter-spacing:.06em;}
.icon-btn{width:36px;height:36px;border-radius:50%;border:1.5px solid var(--line);background:var(--bg2);color:var(--text2);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .18s;box-shadow:var(--s1);}
.icon-btn:active{background:var(--accent);border-color:var(--accent);color:#fff;transform:scale(.88);}

/* â”€â”€â”€ TIMELINE WRAPPER â”€â”€â”€ */
#timeline-wrapper{flex:1;overflow:hidden;position:relative;touch-action:none;background:linear-gradient(175deg,#fdfaf5 0%,#f4ead8 100%);}
#timeline-wrapper::before{content:'';position:absolute;inset:0;pointer-events:none;background-image:radial-gradient(circle,var(--line) 1px,transparent 1px);background-size:32px 32px;opacity:.22;}

/* â”€â”€â”€ AXIS â”€â”€â”€ */
.timeline-axis{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent 0%,var(--line2) 6%,var(--line2) 94%,transparent 100%);pointer-events:none;z-index:2;}
.timeline-axis::after{content:'';position:absolute;inset:-3px 0;background:linear-gradient(90deg,transparent 0%,var(--accent3) 6%,var(--accent3) 94%,transparent 100%);opacity:.45;filter:blur(5px);}

/* â”€â”€â”€ MONTH INDICATOR â”€â”€â”€ */
#month-indicator{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);background:var(--surface);border:1px solid var(--line);border-radius:20px;padding:5px 14px;font-size:.72rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gold);box-shadow:var(--s1);pointer-events:none;z-index:20;opacity:0;transition:opacity .35s;white-space:nowrap;}
#month-indicator.show{opacity:1;}

/* â”€â”€â”€ SCROLL AREA â”€â”€â”€ */
#timeline{height:100%;overflow-x:auto;overflow-y:hidden;display:flex;align-items:flex-start;padding:0 80px;position:relative;scrollbar-width:none;-webkit-overflow-scrolling:touch;will-change:transform;}
#timeline::-webkit-scrollbar{display:none;}

/* â”€â”€â”€ CARDS â”€â”€â”€ */
.card{flex-shrink:0;position:relative;display:flex;flex-direction:column;align-items:center;cursor:pointer;opacity:0;}
.card.visible{animation:cardIn .45s cubic-bezier(.22,1,.36,1) forwards;}
@keyframes cardIn{from{opacity:0;transform:translateY(18px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.card-ripple{position:absolute;border-radius:50%;background:rgba(176,125,85,.25);pointer-events:none;transform:scale(0);animation:ripple .55s ease-out forwards;z-index:10;}
@keyframes ripple{to{transform:scale(4);opacity:0;}}
.card-date{font-family:'Outfit',sans-serif;font-weight:500;letter-spacing:.08em;text-transform:uppercase;color:var(--gold);background:var(--surface);border:1px solid var(--line);border-radius:20px;white-space:nowrap;box-shadow:var(--s1);z-index:3;flex-shrink:0;}
.card-conn{width:1.5px;background:var(--line2);flex-shrink:0;}
.card-dot{border-radius:50%;background:var(--accent);border:2.5px solid var(--surface);flex-shrink:0;z-index:3;transition:box-shadow .2s,transform .2s;}
.card:hover .card-dot,.card:active .card-dot{transform:scale(1.3);box-shadow:0 0 0 4px rgba(212,165,116,.5)!important;}
.card-media{width:100%;position:relative;overflow:hidden;border:2.5px solid var(--surface);box-shadow:var(--s2);background:var(--bg3);flex-shrink:0;transition:transform .22s cubic-bezier(.22,1,.36,1),box-shadow .22s;}
.card:active .card-media{transform:scale(.96);box-shadow:var(--s1);}
.card-media::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,transparent 50%,rgba(44,31,20,.25) 100%);pointer-events:none;}
.card-media img{width:100%;height:100%;object-fit:cover;display:block;}
.card-media img.loading{opacity:0;transition:opacity .5s;}
.card-media img.loaded{opacity:1;}
.card-caption{font-size:.68rem;color:var(--text2);line-height:1.4;text-align:center;padding:5px 3px 2px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;width:100%;}
.year-sep{flex-shrink:0;display:flex;align-items:flex-start;}
.year-pill{font-family:'Cormorant Garamond',serif;font-weight:600;color:var(--accent2);background:rgba(255,255,255,.8);border:1px solid var(--line);border-radius:24px;padding:4px 12px;white-space:nowrap;box-shadow:var(--s1);z-index:4;flex-shrink:0;pointer-events:none;backdrop-filter:blur(4px);}

/* â”€â”€â”€ DELETE CONFIRM â”€â”€â”€ */
#delete-confirm{position:fixed;inset:0;z-index:500;background:rgba(12,8,4,.75);backdrop-filter:blur(6px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;opacity:0;pointer-events:none;transition:opacity .28s;}
#delete-confirm.show{opacity:1;pointer-events:all;}
.del-box{background:var(--surface);border-radius:22px;padding:30px 28px;text-align:center;box-shadow:var(--s3);max-width:300px;width:90%;}
.del-box .del-icon{font-size:2.4rem;margin-bottom:10px;}
.del-box h3{font-family:'Cormorant Garamond',serif;font-size:1.4rem;color:var(--text);margin-bottom:8px;}
.del-box p{font-size:.82rem;color:var(--text3);line-height:1.5;margin-bottom:22px;}
.del-actions{display:flex;gap:10px;}
.btn-cancel{flex:1;padding:12px;border-radius:12px;border:1.5px solid var(--line);background:var(--bg2);color:var(--text2);font-family:'Outfit',sans-serif;font-size:.9rem;cursor:pointer;transition:background .15s;}
.btn-cancel:active{background:var(--bg3);}
.btn-del-ok{flex:1;padding:12px;border-radius:12px;border:none;background:var(--red);color:#fff;font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:500;cursor:pointer;box-shadow:0 4px 12px rgba(192,80,58,.35);transition:opacity .15s;}
.btn-del-ok:active{opacity:.8;}

/* â”€â”€â”€ ZOOM BADGE â”€â”€â”€ */
#zoom-badge{position:fixed;top:64px;right:13px;z-index:50;background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:5px 10px;font-size:.68rem;color:var(--text3);box-shadow:var(--s1);pointer-events:none;opacity:0;transition:opacity .35s;font-variant-numeric:tabular-nums;}
#zoom-badge.show{opacity:1;}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
#empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;pointer-events:none;}
.empty-icon{font-size:2.8rem;opacity:.25;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.empty-text{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1.15rem;color:var(--text3);}

/* â”€â”€â”€ FAB â”€â”€â”€ */
#fab{position:fixed;bottom:22px;right:17px;z-index:100;width:52px;height:52px;border-radius:50%;background:var(--accent);border:none;color:#fff;font-size:1.6rem;cursor:pointer;box-shadow:0 4px 20px rgba(176,125,85,.5);display:flex;align-items:center;justify-content:center;transition:transform .28s cubic-bezier(.34,1.56,.64,1),background .2s,box-shadow .2s;}
#fab.open{background:#8a6050;transform:rotate(45deg);box-shadow:0 4px 12px rgba(100,50,30,.3);}

/* â”€â”€â”€ UPLOAD PANEL â”€â”€â”€ */
#upload-panel{position:fixed;bottom:84px;left:10px;right:10px;background:var(--surface);border:1.5px solid var(--line);border-radius:22px;padding:22px 18px 18px;z-index:99;box-shadow:var(--s3);transform:translateY(calc(100% + 120px));transition:transform .38s cubic-bezier(.34,1.56,.64,1);max-height:78vh;overflow-y:auto;}
#upload-panel.open{transform:translateY(0);}
.panel-title{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:600;color:var(--gold);margin-bottom:18px;}
.form-group{margin-bottom:13px;}
.form-lbl{display:block;font-size:.67rem;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);margin-bottom:5px;font-weight:500;}
.form-input{width:100%;padding:10px 13px;background:var(--bg);border:1.5px solid var(--line);border-radius:10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.9rem;outline:none;transition:border-color .2s;}
.form-input:focus{border-color:var(--accent);}
input[type="date"]::-webkit-calendar-picker-indicator{filter:opacity(.4);cursor:pointer;}
.file-row{display:flex;gap:10px;align-items:stretch;}
.file-btn{flex:1;padding:12px 8px;border:1.5px solid var(--line);border-radius:10px;background:var(--bg);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:5px;color:var(--text2);font-family:'Outfit',sans-serif;font-size:.74rem;font-weight:400;transition:border-color .2s,background .15s;}
.file-btn:active{border-color:var(--accent);background:var(--bg2);}
.file-btn input{display:none;}
.file-btn-icon{font-size:1.5rem;}
#preview-thumb{width:64px;height:64px;border-radius:10px;object-fit:cover;display:none;border:2px solid var(--accent);flex-shrink:0;}

/* ğŸ”’ File validation feedback */
.file-error{font-size:.72rem;color:var(--red);margin-top:5px;min-height:16px;display:none;}
.file-error.show{display:block;}

.save-btn{width:100%;padding:13px;margin-top:8px;background:var(--accent);border:none;border-radius:12px;color:#fff;font-family:'Outfit',sans-serif;font-size:.92rem;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .18s,transform .12s;box-shadow:0 4px 14px rgba(176,125,85,.3);}
.save-btn:disabled{opacity:.4;pointer-events:none;}
.save-btn:active{transform:scale(.96);}
.prog-wrap{height:3px;border-radius:2px;background:var(--line);margin-top:10px;overflow:hidden;}
.prog-bar{height:100%;width:0%;background:var(--accent);border-radius:2px;transition:width .3s;}
.status-msg{text-align:center;font-size:.78rem;color:var(--text3);margin-top:7px;min-height:18px;}

/* â”€â”€â”€ LIGHTBOX â”€â”€â”€ */
#lightbox{position:fixed;inset:0;z-index:200;background:rgba(10,6,2,.91);backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;touch-action:none;}
#lightbox.open{opacity:1;pointer-events:all;}
#lb-topbar{position:absolute;top:0;left:0;right:0;padding:16px;display:flex;align-items:center;justify-content:space-between;z-index:5;background:linear-gradient(180deg,rgba(10,6,2,.7) 0%,transparent 100%);}
#lb-back{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);border-radius:20px;padding:7px 14px;color:rgba(255,255,255,.75);font-size:.75rem;letter-spacing:.08em;cursor:pointer;backdrop-filter:blur(4px);transition:background .18s;font-family:'Outfit',sans-serif;}
#lb-back:active{background:rgba(255,255,255,.22);}
#lb-trash{width:40px;height:40px;border-radius:50%;background:rgba(192,80,58,.18);border:1.5px solid rgba(192,80,58,.35);color:rgba(255,120,100,.8);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .18s;}
#lb-trash:active{background:rgba(192,80,58,.45);}
#lb-img-wrap{position:relative;width:100%;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;}
#lb-img{max-width:92vw;max-height:70vh;border-radius:16px;object-fit:contain;box-shadow:0 24px 80px rgba(0,0,0,.6);user-select:none;pointer-events:none;-webkit-user-drag:none;transition:opacity .22s,transform .22s;}
#lb-img.out-l{opacity:0;transform:translateX(-15%) scale(.95);}
#lb-img.out-r{opacity:0;transform:translateX(15%) scale(.95);}
.lb-arr{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.18);color:#fff;font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);transition:background .18s;z-index:5;}
.lb-arr:active{background:rgba(255,255,255,.28);}
#lb-prev{left:11px;}#lb-next{right:11px;}
#lb-info{padding:12px 24px 20px;text-align:center;flex-shrink:0;}
#lb-date{font-size:.68rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent3);margin-bottom:5px;}
#lb-cap{font-family:'Cormorant Garamond',serif;font-style:italic;color:rgba(255,255,255,.6);font-size:1.05rem;line-height:1.45;}
#lb-ctr{font-size:.65rem;color:rgba(255,255,255,.25);margin-top:6px;letter-spacing:.08em;}
#lb-dots{display:flex;justify-content:center;gap:5px;margin-top:10px;}
.lb-d{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.18);transition:background .22s,transform .22s;}
.lb-d.on{background:var(--accent2);transform:scale(1.45);}
#lb-swipe-hint{position:absolute;top:70px;left:50%;transform:translateX(-50%);font-size:.65rem;letter-spacing:.1em;color:rgba(255,255,255,.2);white-space:nowrap;pointer-events:none;animation:swipeHint 2s 1.5s ease both;}
@keyframes swipeHint{0%,100%{opacity:0}40%,60%{opacity:1}}

/* â”€â”€â”€ CONFETTI â”€â”€â”€ */
.confetti-piece{position:fixed;pointer-events:none;z-index:400;animation:confettiFall var(--dur,1.5s) var(--delay,0s) ease-out forwards;}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1;}100%{transform:translateY(100vh) rotate(720deg);opacity:0;}}

/* grain */
body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.028'/%3E%3C/svg%3E");background-size:200px 200px;opacity:.5;}
</style>
</head>
<body>

<!-- â”€â”€â”€ PIN â”€â”€â”€ -->
<div id="pin-screen">
  <div class="pin-logo">JH<small>âœ¦ Erinnerungen âœ¦</small></div>
  <div class="pin-dots">
    <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-grid">
    <button class="pin-btn" onclick="pinPress(1)">1</button>
    <button class="pin-btn" onclick="pinPress(2)">2</button>
    <button class="pin-btn" onclick="pinPress(3)">3</button>
    <button class="pin-btn" onclick="pinPress(4)">4</button>
    <button class="pin-btn" onclick="pinPress(5)">5</button>
    <button class="pin-btn" onclick="pinPress(6)">6</button>
    <button class="pin-btn" onclick="pinPress(7)">7</button>
    <button class="pin-btn" onclick="pinPress(8)">8</button>
    <button class="pin-btn" onclick="pinPress(9)">9</button>
    <button class="pin-btn del" onclick="pinDel()">âŒ«</button>
    <button class="pin-btn" onclick="pinPress(0)">0</button>
    <button class="pin-btn del" onclick="pinClear()">âœ•</button>
  </div>
  <div class="pin-error" id="pin-error"></div>
  <!-- ğŸ”’ FIX #6 â€” Lockout banner -->
  <div id="lockout-banner">
    ğŸ”’ Gesperrt fÃ¼r <span id="lockout-countdown"></span> Sekunden
  </div>
</div>

<!-- â”€â”€â”€ APP â”€â”€â”€ -->
<div id="app" style="display:none;">
  <header>
    <div class="app-title">JH<small>Erinnerungen</small></div>
    <div class="hdr-r">
      <span id="photo-count">0 Fotos</span>
      <button class="icon-btn" onclick="scrollToEnd()">â€º</button>
      <button class="icon-btn" onclick="scrollToStart()" style="font-size:.8rem;">â€¹</button>
    </div>
  </header>
  <div id="timeline-wrapper">
    <div class="timeline-axis" id="tl-axis"></div>
    <div id="timeline"></div>
    <div id="empty-state">
      <div class="empty-icon">ğŸŒ¸</div>
      <div class="empty-text">Noch keine Erinnerungen</div>
    </div>
    <div id="month-indicator"></div>
  </div>
  <div id="zoom-badge"></div>
</div>

<button id="fab" style="display:none;" onclick="togglePanel()">+</button>

<!-- â”€â”€â”€ UPLOAD PANEL â”€â”€â”€ -->
<div id="upload-panel">
  <div class="panel-title">âœ¦ Moment hinzufÃ¼gen</div>
  <div class="form-group">
    <span class="form-lbl">Foto wÃ¤hlen</span>
    <div class="file-row">
      <!-- ğŸ”’ FIX #8 â€” accept only specific image types -->
      <label class="file-btn">
        <input type="file" id="file-gallery" accept="image/jpeg,image/png,image/webp,image/heic,image/heif" onchange="onFileChange(event)">
        <span class="file-btn-icon">ğŸ–¼ï¸</span><span>Galerie</span>
      </label>
      <label class="file-btn">
        <input type="file" id="file-camera" accept="image/jpeg,image/png,image/webp,image/heic,image/heif" capture="environment" onchange="onFileChange(event)">
        <span class="file-btn-icon">ğŸ“·</span><span>Kamera</span>
      </label>
      <img id="preview-thumb" alt="">
    </div>
    <div class="file-error" id="file-error"></div>
  </div>
  <div class="form-group">
    <label class="form-lbl" for="date-input">Datum</label>
    <input type="date" id="date-input" class="form-input">
  </div>
  <div class="form-group">
    <label class="form-lbl" for="text-input">Beschreibung</label>
    <!-- ğŸ”’ FIX: maxlength prevents excessively long input -->
    <input type="text" id="text-input" class="form-input" placeholder="Was war das fÃ¼r ein Moment?" maxlength="300">
  </div>
  <button class="save-btn" id="save-btn" onclick="uploadMoment()">
    <span id="save-lbl">ğŸ’¾ Speichern</span>
  </button>
  <div class="prog-wrap"><div class="prog-bar" id="prog-bar"></div></div>
  <div class="status-msg" id="status-msg"></div>
</div>

<!-- â”€â”€â”€ DELETE CONFIRM â”€â”€â”€ -->
<div id="delete-confirm">
  <div class="del-box">
    <div class="del-icon">ğŸ—‘ï¸</div>
    <h3>Moment lÃ¶schen?</h3>
    <p>Dieses Foto wird dauerhaft entfernt.<br>Das kann nicht rÃ¼ckgÃ¤ngig gemacht werden.</p>
    <div class="del-actions">
      <button class="btn-cancel" onclick="cancelDelete()">Abbrechen</button>
      <button class="btn-del-ok" id="btn-del-ok" onclick="confirmDelete()">LÃ¶schen</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ LIGHTBOX â”€â”€â”€ -->
<div id="lightbox">
  <div id="lb-topbar">
    <button id="lb-back" onclick="closeLightbox()">â† Timeline</button>
    <button id="lb-trash" onclick="askDelete()">ğŸ—‘ï¸</button>
  </div>
  <div id="lb-swipe-hint">â† wischen zum BlÃ¤ttern â†’</div>
  <div id="lb-img-wrap">
    <button class="lb-arr" id="lb-prev" onclick="lbNav(-1)">â€¹</button>
    <img id="lb-img" src="" alt="">
    <button class="lb-arr" id="lb-next" onclick="lbNav(1)">â€º</button>
  </div>
  <div id="lb-info">
    <div id="lb-date"></div>
    <div id="lb-cap"></div>
    <div id="lb-ctr"></div>
    <div id="lb-dots"></div>
  </div>
</div>

<!-- â”€â”€â”€ FIREBASE â”€â”€â”€ -->
<script type="module">
import { initializeApp }        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc,
         onSnapshot, query, orderBy, serverTimestamp, Timestamp }
                               from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
                               from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”’ SECURITY CONFIG
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PIN_HASH = SHA-256("1234")
   â†’ Zum Ã„ndern: neuen PIN hashen mit:
     https://emn178.github.io/online-tools/sha256.html
   â†’ Dann diesen String ersetzen.

   Firebase API-Key: In Google Cloud Console einschrÃ¤nken auf:
   â†’ HTTP-Referrer: https://DEIN-GITHUB-USERNAME.github.io/*

   Cloudinary: Upload Preset "timeline" einschrÃ¤nken auf:
   â†’ Allowed formats: jpg,png,webp,heic
   â†’ Max file size: 15 MB
   â†’ Folder: timeline/
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PIN_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4";
// â†‘ SHA-256 von "1234" â€” BITTE VOR PRODUKTIVEINSATZ Ã„NDERN

const CLOUDINARY_HOST = "res.cloudinary.com"; // ğŸ”’ FIX #5 erlaubte Bild-Domain
const CL_URL          = "https://api.cloudinary.com/v1_1/db98q2eok/image/upload";
const CL_PRESET       = "timeline";

/* ğŸ”’ FIX #8 â€” Erlaubte Dateitypen + Max-GrÃ¶ÃŸe */
const ALLOWED_TYPES = ["image/jpeg","image/png","image/webp","image/heic","image/heif"];
const MAX_FILE_MB   = 20;

const fbCfg = {
  apiKey:"AIzaSyAc3oaP6Dp0DUaum3e7YNLtO6lSzuXXtro",
  authDomain:"hansjoergultimeline.firebaseapp.com",
  projectId:"hansjoergultimeline",
  storageBucket:"hansjoergultimeline.firebasestorage.app",
  messagingSenderId:"616046735856",
  appId:"1:616046735856:web:c8e68d41725d6a41212d35"
};

const fbApp = initializeApp(fbCfg);
const db    = getFirestore(fbApp);
const auth  = getAuth(fbApp);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”’ FIREBASE ANONYMOUS AUTH
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Meldet den Browser-Client anonym an Firebase an.
   Ohne dieses Token lehnen die Firestore-Regeln alle
   Lese- und Schreibzugriffe ab ("Missing permissions").
   Der Nutzer sieht davon nichts â€” kein Login-Dialog.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let authReady = false;

// Sign in once on page load (silently, in background)
signInAnonymously(auth).catch(err => {
  console.error("Firebase Auth Fehler:", err);
});

// Wait for auth to be confirmed before allowing Firestore writes
onAuthStateChanged(auth, user => {
  authReady = !!user;
});

/* â”€â”€â”€ APP STATE â”€â”€â”€ */
let moments       = [];
let cardSize      = 200;
let visualScale   = 1;
const MIN = 70, MAX = 360;
let selectedFile  = null;
let lbIdx         = 0;
let deleteId      = null;
let badgeTimer    = null;
let monthTimer    = null;
let pinchStartSize= 200;
let pinchStartDist= 0;
let isPinching    = false;
let isFirstUpload = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”’ FIX #1 + #6 â€” PIN: SHA-256 Hash + Brute-Force-Schutz
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pinBuf       = "";
let failCount    = 0;
const MAX_FAILS  = 5;      // Versuche bevor Sperre
const LOCK_MS    = 30000;  // 30 Sekunden Sperre
let lockedUntil  = 0;
let lockInterval = null;

window.pinPress = n => {
  /* Gesperrt? */
  if(Date.now() < lockedUntil) return;
  if(pinBuf.length < 4){
    pinBuf += String(n);
    updDots();
    if(pinBuf.length === 4) checkPin();
  }
};
window.pinDel   = ()=>{ if(Date.now()<lockedUntil)return; pinBuf=pinBuf.slice(0,-1); updDots(); };
window.pinClear = ()=>{ if(Date.now()<lockedUntil)return; pinBuf=""; updDots(); };

function updDots(){
  for(let i=0;i<4;i++) $("d"+i).classList.toggle("filled", i < pinBuf.length);
}

/* SHA-256 via Web Crypto API (built-in, no library needed) */
async function sha256(str){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function checkPin(){
  const hash = await sha256(pinBuf);
  if(hash === PIN_HASH){
    /* âœ“ Correct â€” reset counters and open app */
    failCount = 0; lockedUntil = 0;
    clearInterval(lockInterval);
    $("pin-screen").style.display = "none";
    const a = $("app"); a.style.display = "flex";
    requestAnimationFrame(()=>a.classList.add("ready"));
    $("fab").style.display = "flex";
    initApp();
  } else {
    /* âœ— Wrong PIN */
    failCount++;
    pinBuf = ""; updDots();
    const errEl = $("pin-error");

    if(failCount >= MAX_FAILS){
      /* Lock */
      lockedUntil = Date.now() + LOCK_MS;
      failCount   = 0;
      errEl.textContent = "";
      errEl.classList.remove("show");
      startLockdown();
    } else {
      const left = MAX_FAILS - failCount;
      errEl.textContent = `Falscher PIN. Noch ${left} Versuch${left!==1?"e":""}.`;
      errEl.classList.add("show","pin-shake");
      setTimeout(()=>errEl.classList.remove("show","pin-shake"), 1600);
    }
  }
}

function startLockdown(){
  const banner   = $("lockout-banner");
  const cntEl    = $("lockout-countdown");
  banner.classList.add("show");
  /* Disable all pin buttons */
  document.querySelectorAll(".pin-btn").forEach(b=>b.disabled=true);

  function tick(){
    const left = Math.max(0, Math.ceil((lockedUntil - Date.now()) / 1000));
    cntEl.textContent = left;
    if(left <= 0){
      clearInterval(lockInterval);
      banner.classList.remove("show");
      document.querySelectorAll(".pin-btn").forEach(b=>b.disabled=false);
    }
  }
  tick();
  lockInterval = setInterval(tick, 500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”’ FIX #5 â€” URL-Validierung (verhindert XSS via Firestore)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function safeImageUrl(url){
  try {
    const u = new URL(url);
    if(u.protocol !== "https:") return "";
    if(!u.hostname.endsWith(CLOUDINARY_HOST)) return "";
    // Keine javascript: oder data: URIs mÃ¶glich
    return url;
  } catch { return ""; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”’ FIX #8 â€” Datei-Validierung (Typ + GrÃ¶ÃŸe)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function validateFile(file){
  const errEl = $("file-error");
  if(!ALLOWED_TYPES.includes(file.type)){
    errEl.textContent = "âŒ Nur JPG, PNG, WebP oder HEIC erlaubt.";
    errEl.classList.add("show");
    return false;
  }
  if(file.size > MAX_FILE_MB * 1024 * 1024){
    errEl.textContent = `âŒ Datei zu groÃŸ (max. ${MAX_FILE_MB} MB).`;
    errEl.classList.add("show");
    return false;
  }
  errEl.classList.remove("show");
  return true;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp(){
  $("date-input").valueAsDate = new Date();
  positionAxis();
  window.addEventListener("resize",()=>{ positionAxis(); renderTimeline(); });

  // Wait for anonymous auth before opening Firestore listener
  onAuthStateChanged(auth, user => {
    if(!user) return; // not yet signed in
    const q = query(collection(db,"momente"), orderBy("eventDate","asc"));
    onSnapshot(q, snap => {
      const prev = moments.length;
      moments = [];
      snap.forEach(d => moments.push({id:d.id, ...d.data()}));
      $("photo-count").textContent = `${moments.length} Foto${moments.length!==1?"s":""}`;
      $("empty-state").style.display = moments.length===0 ? "flex" : "none";
      renderTimeline();
      if(isFirstUpload && moments.length > prev){ launchConfetti(); isFirstUpload=false; }
    });
  });

  $("timeline").addEventListener("scroll", onTimelineScroll, {passive:true});
}

function axisY(){ return $("timeline-wrapper").clientHeight * 0.38; }
function positionAxis(){ $("tl-axis").style.top = axisY()+"px"; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER TIMELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTimeline(){
  const tl   = $("timeline");
  const ay   = axisY();
  const sz   = cardSize;

  const photoH    = sz * 1.28;
  const dateH     = sz < 120 ? 16 : 22;
  const connTop   = sz < 110 ?  4 : 11;
  const dotSz     = sz < 110 ?  6 :  9;
  const connBot   = sz < 110 ?  3 :  7;
  const abovePhoto= dateH + connTop + dotSz + connBot;
  const cardTop   = ay - abovePhoto;
  const dateFs    = Math.max(.48, Math.min(.66, sz/295));
  const capShow   = sz > 115;
  const yearShow  = sz > 130;
  const r         = sz < 110 ? "7px" : "13px";

  let gap;
  if(sz < 90)       gap = -sz * 0.45;
  else if(sz < 120) gap = -sz * 0.28;
  else if(sz < 160) gap = -sz * 0.08;
  else              gap = Math.max(8, sz * 0.06);

  const scrollRatio = tl.scrollWidth > 0 ? tl.scrollLeft / tl.scrollWidth : 0;
  tl.innerHTML = "";
  let lastYear = null;

  moments.forEach((m, idx) => {
    const d  = toDate(m.eventDate);
    const yr = d.getFullYear();

    if(yearShow && yr !== lastYear){
      if(idx > 0){
        const sep  = document.createElement("div");
        sep.className = "year-sep";
        sep.style.cssText = `margin-top:${cardTop}px;margin-left:${gap<0?Math.abs(gap)*0.3:6}px;margin-right:${gap<0?Math.abs(gap)*0.3:6}px;`;
        const pill = document.createElement("div");
        pill.className = "year-pill";
        pill.style.cssText = `margin-top:${abovePhoto*0.35}px;font-size:${Math.min(.95,sz/220)}rem;`;
        pill.textContent = yr;
        sep.appendChild(pill);
        tl.appendChild(sep);
      }
      lastYear = yr;
    }

    /* ğŸ”’ FIX #5 â€” Validate URL before rendering */
    const safeUrl = safeImageUrl(m.imageUrl);
    if(!safeUrl) return; // skip invalid/suspicious entries

    const card = document.createElement("div");
    card.className = "card";
    card.dataset.idx = idx;
    card.style.cssText = `width:${sz}px;margin-top:${cardTop}px;margin-left:${idx>0?gap:0}px;`;

    /* Build card with textContent / createElement (no innerHTML with user data for safety) */
    const datePill = document.createElement("div");
    datePill.className = "card-date";
    datePill.style.cssText = `font-size:${dateFs}rem;padding:${sz<120?"2px 6px":"3px 10px"};`;
    datePill.textContent = fmtDate(d, sz);  // textContent = safe

    const conn1 = document.createElement("div");
    conn1.className = "card-conn"; conn1.style.height = connTop+"px";

    const dot = document.createElement("div");
    dot.className = "card-dot";
    dot.style.cssText = `width:${dotSz}px;height:${dotSz}px;box-shadow:0 0 0 ${sz<110?1.5:2}px var(--accent2);`;

    const conn2 = document.createElement("div");
    conn2.className = "card-conn"; conn2.style.height = connBot+"px";

    const media = document.createElement("div");
    media.className = "card-media";
    media.style.cssText = `height:${photoH}px;border-radius:${r};`;

    const img = document.createElement("img");
    img.src     = safeUrl;           // ğŸ”’ validated URL only
    img.alt     = m.text || "";      // textContent equivalent
    img.loading = "lazy";
    img.className = "loading";
    img.addEventListener("load", ()=>{ img.classList.add("loaded"); img.classList.remove("loading"); });
    media.appendChild(img);

    card.appendChild(datePill);
    card.appendChild(conn1);
    card.appendChild(dot);
    card.appendChild(conn2);
    card.appendChild(media);

    if(capShow && m.text){
      const cap = document.createElement("div");
      cap.className = "card-caption";
      cap.textContent = m.text;  // ğŸ”’ textContent = no XSS possible
      card.appendChild(cap);
    }

    card.addEventListener("click", e => { addRipple(card,e); openLightbox(idx); });
    tl.appendChild(card);
  });

  if(scrollRatio > 0) tl.scrollLeft = tl.scrollWidth * scrollRatio;
  observeCards();
}

function observeCards(){
  const io = new IntersectionObserver(entries => {
    entries.forEach(e => { if(e.isIntersecting){ e.target.classList.add("visible"); io.unobserve(e.target); } });
  }, {threshold:.1});
  document.querySelectorAll(".card").forEach(c => io.observe(c));
}

function addRipple(card, e){
  const r = document.createElement("div");
  r.className = "card-ripple";
  const rect = card.getBoundingClientRect();
  r.style.cssText = `width:40px;height:40px;left:${e.clientX-rect.left-20}px;top:${e.clientY-rect.top-20}px;`;
  card.appendChild(r);
  r.addEventListener("animationend", ()=>r.remove());
}

function toDate(v){ return v?.toDate ? v.toDate() : new Date(v); }
function fmtDate(d, sz){
  if(sz >= 185) return d.toLocaleDateString("de-DE",{day:"2-digit",month:"short",year:"2-digit"});
  if(sz >= 120) return d.toLocaleDateString("de-DE",{month:"short",year:"2-digit"});
  return String(d.getFullYear()).slice(2)+"'";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMOOTH PINCH-TO-ZOOM (GPU-accelerated during gesture)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const wrapper = $("timeline-wrapper");
const tlEl    = $("timeline");

wrapper.addEventListener("touchstart", e => {
  if(e.touches.length === 2){
    e.preventDefault();
    isPinching      = true;
    pinchStartDist  = tdist(e.touches[0], e.touches[1]);
    pinchStartSize  = cardSize;
    visualScale     = 1;
    tlEl.style.transition     = "none";
    tlEl.style.transformOrigin= "center center";
  }
},{passive:false});

wrapper.addEventListener("touchmove", e => {
  if(isPinching && e.touches.length === 2){
    e.preventDefault();
    const d2       = tdist(e.touches[0], e.touches[1]);
    const rawScale = d2 / pinchStartDist;
    const newSize  = clamp(pinchStartSize * rawScale, MIN, MAX);
    visualScale    = newSize / pinchStartSize;
    tlEl.style.transform = `scaleX(${visualScale})`;
    showBadge(newSize);
  }
},{passive:false});

wrapper.addEventListener("touchend", e => {
  if(e.touches.length < 2 && isPinching){
    isPinching = false;
    cardSize   = clamp(pinchStartSize * visualScale, MIN, MAX);
    tlEl.style.transform  = "";
    tlEl.style.transition = "";
    renderTimeline();
  }
},{passive:true});

function tdist(a,b){ return Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY); }
function clamp(v,lo,hi){ return Math.min(hi, Math.max(lo, v)); }

function showBadge(sz){
  const b = $("zoom-badge");
  const pct = Math.round((sz-MIN)/(MAX-MIN)*100);
  b.textContent = `${pct}%`;
  b.classList.add("show");
  clearTimeout(badgeTimer);
  badgeTimer = setTimeout(()=>b.classList.remove("show"), 1600);
}

/* â”€â”€â”€ Month indicator â”€â”€â”€ */
function onTimelineScroll(){
  if(!moments.length) return;
  const tl  = $("timeline");
  const mid = tl.scrollLeft + tl.clientWidth/2;
  const idx = Math.min(moments.length-1, Math.floor((mid/tl.scrollWidth)*moments.length));
  const m   = moments[idx];
  if(!m) return;
  const label = toDate(m.eventDate).toLocaleDateString("de-DE",{month:"long",year:"numeric"});
  const mi = $("month-indicator");
  mi.textContent = label;  // ğŸ”’ textContent
  mi.classList.add("show");
  clearTimeout(monthTimer);
  monthTimer = setTimeout(()=>mi.classList.remove("show"), 1500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIGHTBOX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openLightbox = idx => { lbIdx=idx; fillLb(); $("lightbox").classList.add("open"); };
window.closeLightbox= ()  => $("lightbox").classList.remove("open");

window.lbNav = dir => {
  const img = $("lb-img");
  img.classList.add(dir<0 ? "out-r" : "out-l");
  setTimeout(()=>{ lbIdx=(lbIdx+dir+moments.length)%moments.length; fillLb(); }, 210);
};

function fillLb(){
  const m = moments[lbIdx];
  if(!m) return;
  const safeUrl = safeImageUrl(m.imageUrl);  // ğŸ”’ validate
  $("lb-img").classList.remove("out-l","out-r");
  $("lb-img").src = safeUrl;
  const d = toDate(m.eventDate);
  $("lb-date").textContent = d.toLocaleDateString("de-DE",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
  $("lb-cap").textContent  = m.text || "";   // ğŸ”’ textContent
  $("lb-ctr").textContent  = `${lbIdx+1} von ${moments.length}`;
  const dots = $("lb-dots"); dots.innerHTML="";
  const t=moments.length, s=Math.max(0,lbIdx-3), e2=Math.min(t-1,lbIdx+3);
  for(let i=s;i<=e2;i++){
    const d2=document.createElement("div");
    d2.className="lb-d"+(i===lbIdx?" on":"");
    dots.appendChild(d2);
  }
  const multi = t>1;
  $("lb-prev").style.display = multi?"flex":"none";
  $("lb-next").style.display = multi?"flex":"none";
}

let lbTX=null, lbTY=null;
$("lb-img-wrap").addEventListener("touchstart",e=>{lbTX=e.touches[0].clientX;lbTY=e.touches[0].clientY;},{passive:true});
$("lb-img-wrap").addEventListener("touchend",e=>{
  if(lbTX===null)return;
  const dx=e.changedTouches[0].clientX-lbTX;
  const dy=e.changedTouches[0].clientY-lbTY;
  lbTX=lbTY=null;
  if(Math.abs(dy)>Math.abs(dx)&&dy>55){closeLightbox();return;}
  if(Math.abs(dx)>45) lbNav(dx<0?1:-1);
},{passive:true});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DELETE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.askDelete = ()=>{ const m=moments[lbIdx]; if(!m)return; deleteId=m.id; $("delete-confirm").classList.add("show"); };
window.cancelDelete = ()=>{ deleteId=null; $("delete-confirm").classList.remove("show"); };
window.confirmDelete= async()=>{
  if(!deleteId) return;
  const btn=$("btn-del-ok"); btn.textContent="â€¦"; btn.disabled=true;
  try{
    await deleteDoc(doc(db,"momente",deleteId));
    $("delete-confirm").classList.remove("show");
    closeLightbox();
    deleteId=null;
    btn.textContent="LÃ¶schen"; btn.disabled=false;
  }catch(err){
    console.error(err);
    btn.textContent="Fehler!";
    setTimeout(()=>{btn.textContent="LÃ¶schen";btn.disabled=false;},2000);
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.onFileChange = e => {
  const file = e.target.files[0];
  if(!file) return;
  /* ğŸ”’ FIX #8 â€” Validate immediately on selection */
  if(!validateFile(file)){
    selectedFile = null;
    e.target.value = "";
    $("preview-thumb").style.display = "none";
    return;
  }
  selectedFile = file;
  const th = $("preview-thumb");
  th.src = URL.createObjectURL(file);
  th.style.display = "block";
};

window.uploadMoment = async () => {
  if(!selectedFile){ setStatus("Bitte ein Foto wÃ¤hlen."); return; }
  if(!validateFile(selectedFile)){ return; }
  if(!authReady){ setStatus("â³ Verbindung wird aufgebaut, bitte kurz wartenâ€¦"); return; }

  const dv   = $("date-input").value;
  if(!dv){ setStatus("Datum fehlt."); return; }

  /* ğŸ”’ Sanitize text input */
  const text = $("text-input").value.trim().slice(0, 300);

  const btn=$("save-btn"), lbl=$("save-lbl");
  btn.disabled=true; lbl.textContent="Wird hochgeladenâ€¦";
  setStatus("Foto wird hochgeladenâ€¦"); setProg(15);

  try{
    const form = new FormData();
    form.append("file", selectedFile);
    form.append("upload_preset", CL_PRESET);
    const res  = await fetch(CL_URL, {method:"POST", body:form});
    if(!res.ok) throw new Error("Cloudinary "+res.status);
    const json = await res.json();

    /* ğŸ”’ FIX #5 â€” Validate Cloudinary response URL before saving */
    const imageUrl = safeImageUrl(json.secure_url);
    if(!imageUrl) throw new Error("UngÃ¼ltige Bild-URL von Cloudinary.");

    setProg(72); setStatus("Wird gespeichertâ€¦");
    const [y,mo,d] = dv.split("-").map(Number);
    const eventDate= Timestamp.fromDate(new Date(y,mo-1,d));
    if(moments.length===0) isFirstUpload=true;

    await addDoc(collection(db,"momente"),{
      imageUrl,           // ğŸ”’ validated URL
      text,               // ğŸ”’ trimmed + length-capped
      eventDate,
      createdAt: serverTimestamp()
    });

    setProg(100); setStatus("âœ“ Gespeichert!");
    lbl.textContent="ğŸ’¾ Speichern"; btn.disabled=false;
    selectedFile=null;
    ["file-gallery","file-camera"].forEach(id=>$(id).value="");
    $("text-input").value=""; $("preview-thumb").style.display="none";
    $("date-input").valueAsDate=new Date();
    setTimeout(()=>{ setProg(0); setStatus(""); togglePanel(); setTimeout(scrollToEnd,500); },1400);

  }catch(err){
    console.error(err); setStatus("âŒ "+err.message);
    lbl.textContent="Erneut versuchen"; btn.disabled=false; setProg(0);
  }
};

function setProg(p){ $("prog-bar").style.width=p+"%"; }
function setStatus(t){ $("status-msg").textContent=t; } // ğŸ”’ textContent

/* â”€â”€â”€ Confetti â”€â”€â”€ */
function launchConfetti(){
  const colors=["#d4a574","#b07d55","#f4d5a0","#a8c8a0","#c0d4f0","#f0a0a0","#d4b0e0"];
  for(let i=0;i<60;i++){
    const c=document.createElement("div");
    c.className="confetti-piece";
    c.style.cssText=`left:${20+Math.random()*60}%;background:${colors[i%colors.length]};border-radius:${Math.random()>.5?"50%":"2px"};width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;--dur:${1.2+Math.random()*.8}s;--delay:${Math.random()*.6}s;`;
    document.body.appendChild(c);
    c.addEventListener("animationend",()=>c.remove());
  }
}

/* â”€â”€â”€ Helpers â”€â”€â”€ */
window.togglePanel   = ()=>{ $("upload-panel").classList.toggle("open"); $("fab").classList.toggle("open"); };
window.scrollToEnd   = ()=>$("timeline").scrollTo({left:$("timeline").scrollWidth,behavior:"smooth"});
window.scrollToStart = ()=>$("timeline").scrollTo({left:0,behavior:"smooth"});

document.addEventListener("touchmove",e=>{if(e.touches.length>1)e.preventDefault();},{passive:false});
document.addEventListener("dblclick",e=>e.preventDefault(),{passive:false});

function $(id){ return document.getElementById(id); }
</script>
</body>
</html>
