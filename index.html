<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unsere Familien-Timeline</title>
    <style>
        :root { --accent: #ff6b6b; --bg: #f4f7f6; --text: #333; --card-size: 280px; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }
        
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        header h2 { margin: 0; color: var(--accent); font-size: 1.2rem; }

        /* TIMELINE CONTAINER */
        #timeline-container { flex-grow: 1; overflow-x: auto; overflow-y: hidden; display: flex; align-items: center; padding: 0 50vw; position: relative; -webkit-overflow-scrolling: touch; }
        .timeline-line { position: absolute; top: 45%; left: 0; width: 100000px; height: 2px; background: #ccd; z-index: 0; }
        #timeline-list { display: flex; gap: 40px; z-index: 1; align-items: flex-start; }

        /* TIMELINE ELEMENT */
        .timeline-item { display: flex; flex-direction: column; align-items: center; width: var(--card-size); }
        .date-badge { background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; overflow: hidden; transition: transform 0.2s; }
        .card img { width: 100%; height: var(--card-size); object-fit: cover; display: block; background: #eee; }
        .card-content { padding: 15px; background: white; min-height: 50px; }
        .card-text { font-size: 0.95rem; line-height: 1.4; color: #444; }

        /* UPLOAD BEREICH */
        footer { background: white; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 10; }
        .upload-controls { display: flex; flex-direction: column; gap: 10px; max-width: 500px; margin: 0 auto; }
        .row { display: flex; gap: 10px; }
        input[type="file"] { flex: 1; font-size: 0.8rem; }
        input[type="date"], input[type="text"] { padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        input[type="text"] { flex-grow: 1; }
        button { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        #status { text-align: center; margin-top: 10px; font-size: 0.8rem; color: #666; height: 1em; }
    </style>
</head>
<body>

<div id="login-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
    <h1 style="font-size: 4rem; margin: 0;">ðŸ‘¶</h1>
    <h2>Familien Login</h2>
    <input type="password" id="pin-field" placeholder="PIN eingeben" style="padding: 15px; border-radius: 10px; border: 1px solid #ddd; text-align: center; font-size: 1.2rem; width: 200px; margin-bottom: 20px;">
    <button onclick="checkAccess()" style="width: 230px;">Timeline Ã¶ffnen</button>
</div>

<div id="main-app" class="hidden">
    <header>
        <h2>âœ¨ Unsere Momente</h2>
    </header>

    <div id="timeline-container">
        <div class="timeline-line"></div>
        <div id="timeline-list"></div>
    </div>

    <footer>
        <div class="upload-controls">
            <div class="row">
                <input type="file" id="file-btn" accept="image/*">
                <input type="date" id="date-field">
            </div>
            <input type="text" id="desc-field" placeholder="Was ist heute passiert?">
            <button id="upload-btn">Moment speichern</button>
            <p id="status"></p>
        </div>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Deine Konfiguration
    const firebaseConfig = {
        apiKey: "AIzaSyAc3oaP6Dp0DUaum3e7YNLtO6lSzuXXtro",
        authDomain: "hansjoergultimeline.firebaseapp.com",
        projectId: "hansjoergultimeline",
        storageBucket: "hansjoergultimeline.firebasestorage.app",
        messagingSenderId: "616046735856",
        appId: "1:616046735856:web:c8e68d41725d6a41212d35"
    };

    const CLOUD_NAME = "db98q2eok"; 
    const UPLOAD_PRESET = "timeline"; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // LOGIN PRÃœFUNG
    window.checkAccess = function() {
        if(document.getElementById('pin-field').value === "1234") {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('date-field').valueAsDate = new Date();
            loadTimeline();
        } else {
            alert("Falscher PIN!");
        }
    };

    // UPLOAD LOGIK
    document.getElementById('upload-btn').onclick = async () => {
        const file = document.getElementById('file-btn').files[0];
        const desc = document.getElementById('desc-field').value;
        const date = document.getElementById('date-field').value;
        const status = document.getElementById('status');

        if(!file || !desc || !date) return alert("Bitte Bild, Text und Datum eingeben!");

        status.innerText = "â³ Foto wird Ã¼bertragen...";
        document.getElementById('upload-btn').disabled = true;

        try {
            // 1. Upload zu Cloudinary
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            const cloudRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: formData
            });
            const cloudData = await cloudRes.json();
            
            if(!cloudData.secure_url) throw new Error("Cloudinary Upload fehlgeschlagen");

            // 2. Link in Firebase speichern
            await addDoc(collection(db, "momente"), {
                imageUrl: cloudData.secure_url,
                text: desc,
                eventDate: new Date(date).getTime(),
                createdAt: Date.now()
            });

            status.innerText = "âœ… Erfolgreich gespeichert!";
            document.getElementById('desc-field').value = "";
            document.getElementById('file-btn').value = "";
        } catch (e) {
            console.error(e);
            status.innerText = "âŒ Fehler beim Speichern!";
        } finally {
            document.getElementById('upload-btn').disabled = false;
            setTimeout(() => { status.innerText = ""; }, 3000);
        }
    };

    // TIMELINE DATEN LADEN
    function loadTimeline() {
        const q = query(collection(db, "momente"), orderBy("eventDate", "asc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('timeline-list');
            list.innerHTML = "";
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const d = new Date(data.eventDate).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                list.innerHTML += `
                    <div class="timeline-item">
                        <div class="date-badge">${d}</div>
                        <div class="card">
                            <img src="${data.imageUrl}" loading="lazy" alt="Moment">
                            <div class="card-content">
                                <div class="card-text">${data.text}</div>
                            </div>
                        </div>
                    </div>`;
            });

            // Automatisch zum Ende (neuestes Bild) scrollen
            setTimeout(() => {
                const container = document.getElementById('timeline-container');
                container.scrollLeft = container.scrollWidth;
            }, 500);
        });
    }
</script>

</body>
</html>
